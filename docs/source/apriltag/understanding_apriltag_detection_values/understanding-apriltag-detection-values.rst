AprilTag 検出値の理解
====================================

*最終更新: 2023年7月5日*

はじめに
--------

新しい **SDK** ビジョン処理システムによって**AprilTag** が検出されると、コアコードは容易に解釈できないことが多い生データのコレクションを返します。しかし、データはさらに馴染みのあるフレームワークに変換して、より簡単に利用できるようになります。**FIRST**Tech Challenge**SDK** では、**AprilTag API** はチームの**OpMode** に、3D空間でのタグの位置を表す変換値と回転値のコレクション（**ftcPose** と呼ばれる）を提示します。

これらの値を解釈する方法を理解するには、垂直成分を無視したより単純な2Dシナリオを考える方が簡単です。これを以下に説明します。

以下の** 図1** は、考えられる2Dシナリオの1つを表しています。

.. figure:: images/figure1.jpg
   :width: 40%
   :alt: 図1
   :align: center

   図1: AprilTag シナリオの上面図

この図は、カメラと**AprilTag** を上から見たものです。カメラの「前方」方向は、カメラから真っすぐ引かれた破線で識別されます。**AprilTag** 画像は図の左上に示されています。タグは、カメラから前方に100ユニット、左に36.4ユニット（前方視線に対して直角に測定）の位置にあります。**AprilTag** は、通常の「正面」向きから反時計回りに5度回転しています。

1つの考えられる検出シナリオを明確に理解したので、**SDK** によって**ftcPose** として返されるさまざまな値の意味を見ることができます。** 図2** は、図1に示されているカメラ/ターゲットシナリオに関連する測定値を示しています。

.. figure:: images/figure2.jpg
   :width: 40%
   :alt: 図2
   :align: center

   図2: ftcPose 値の測定

検出値
------**X 座標**: これは、カメラの前方視線に対して直角に測定された、タグの横方向の位置です。正の値は左、負の値は右を示します。**Y 座標**: これは、カメラの前方視線に沿って測定された、タグの前方距離です。正の値は前方、負の値は後方を示します。**Z 座標**: これは、カメラの中心線に対して直角に測定された、タグの垂直位置です。正の値は上、負の値は下を示します。この値は2Dシナリオでは無視されます。** 範囲**: これは、カメラの中心からタグの中心までの直線距離です。** 方位**: これは、カメラの前方視線からタグの中心までの角度です。正の値は左、負の値は右を示します。** 仰角**: これは、カメラの水平線からタグの中心までの角度です。正の値は上、負の値は下を示します。この値は2Dシナリオでは無視されます。** ヨー**: これは、タグの中心を通る垂直軸を中心としたタグの回転です。正の値は反時計回り、負の値は時計回りの回転を示します。** ピッチ**: これは、タグの中心を通る水平軸を中心としたタグの回転です。正の値は上方への傾き、負の値は下方への傾きを示します。この値は2Dシナリオでは無視されます。** ロール**: これは、カメラからタグへの視線を中心としたタグの回転です。正の値は反時計回り、負の値は時計回りの回転を示します。この値は2Dシナリオでは無視されます。

例
--

図1と図2のシナリオでは、次の値が**ftcPose** に返されます：

.. code-block:: text

   x = 36.4 (左に36.4ユニット)
   y = 100.0 (前方に100ユニット)
   z = 0.0 (2Dシナリオでは無視)
   range = 106.4 (カメラから106.4ユニット)
   bearing = 20.0 (左に20度)
   elevation = 0.0 (2Dシナリオでは無視)
   yaw = 5.0 (反時計回りに5度)
   pitch = 0.0 (2Dシナリオでは無視)
   roll = 0.0 (2Dシナリオでは無視)

別の例を見てみましょう。** 図3** は、カメラとタグの異なる配置を示しています。

.. figure:: images/figure3.jpg
   :width: 40%
   :alt: 図3
   :align: center

   図3: 別のシナリオ

この例では、タグはカメラから右に移動し、時計回りに回転しています。**ftcPose** の値は次のようになります：

.. code-block:: text

   x = -50.0 (右に50ユニット)
   y = 86.6 (前方に86.6ユニット)
   z = 0.0 (2Dシナリオでは無視)
   range = 100.0 (カメラから100ユニット)
   bearing = -30.0 (右に30度)
   elevation = 0.0 (2Dシナリオでは無視)
   yaw = -15.0 (時計回りに15度)
   pitch = 0.0 (2Dシナリオでは無視)
   roll = 0.0 (2Dシナリオでは無視)

3Dシナリオ
----------

実際の競技では、カメラとタグは3D空間に配置されます。このシナリオでは、**Z 座標** 、** 仰角** 、** ピッチ** 、** ロール** の値が意味を持ちます。** 図4** は、カメラとタグの3D配置を示しています。

.. figure:: images/figure4.jpg
   :width: 40%
   :alt: 図4
   :align: center

   図4: 3Dシナリオ

この例では、タグはカメラの上方に配置され、下方に傾いています。**ftcPose** の値は次のようになります：

.. code-block:: text

   x = 0.0 (横方向のオフセットなし)
   y = 100.0 (前方に100ユニット)
   z = 50.0 (上に50ユニット)
   range = 111.8 (カメラから111.8ユニット)
   bearing = 0.0 (左右のオフセットなし)
   elevation = 26.6 (上に26.6度)
   yaw = 0.0 (回転なし)
   pitch = -20.0 (下方に20度傾斜)
   roll = 0.0 (ロール回転なし)

まとめ
------**ftcPose** によって提供される値は、カメラに対する**AprilTag** の位置と向きを完全に記述します。これらの値を理解することで、ロボットのナビゲーションと位置決めに効果的に使用できます。

主なポイント：

-**X、Y、Z 座標** は、カメラに対するタグの位置を示します
-** 範囲** と** 方位** は、極座標系での位置を提供します
-** ヨー、ピッチ、ロール** は、タグの3D回転を記述します
- 2Dシナリオでは、**Z** 、** 仰角** 、** ピッチ** 、** ロール** は通常ゼロまたは無視されます

これらの値を適切に解釈することで、**OpMode** は**AprilTag** 検出を使用してロボットを正確に制御できます。

====

*Questions, comments and corrections to westsiderobotics@verizon.net*

