外部UVCカメラとパワード USB ハブの構成
========================================

はじめに
--------

競技マニュアルでは、コンピュータビジョン関連のタスクにおいて、USB Video Class（UVC）互換のカメラの使用を認めています。
**Robot Controller** として Android スマートフォンを使用しているチームは、内蔵カメラの代わりに外部接続カメラを使用することで、コンピュータビジョンタスク用に使用することができます。

外部カメラを使用する利点は、カメラとロボットコントローラーをそれぞれ最適な位置に設置できることです。カメラはビジョン関連タスクに適した位置に、Android **Robot Controller** はロボット制御に適した位置に配置することが可能です。

外部カメラを使用する欠点として、USB接続されたカメラによる追加の複雑性が生じることが挙げられます。外部カメラはロボットにコストと重量を追加し、適切に動作するように正しく配線する必要があります。

どのような種類の外部カメラが使用できますか？
--------------------------------------------

このシステムは UVC カメラに対応しています。
理論上、カメラが UVC に準拠していれば、このシステムで動作するはずです。ただし、**FIRST** Tech Challenge ソフトウェアでテストされ、このソフトウェアで正確に動作するようにキャリブレーションされた推奨ウェブカメラが数台あります：

-  **Logitech HD Webcam C310**
-  **Logitech HD Pro Webcam C920**

:doc:`他の UVC ウェブカメラに関する記事 <../../../apriltag/vision_portal/visionportal_webcams/visionportal-webcams>`
がありますので、チームで使用することができます。

UVC カメラのキャリブレーションは高度なタスクです。キャリブレーションファイルの作成方法に関する詳細は、
ftc_app プロジェクトフォルダーの一部として利用可能な
*teamwebcamcalibrations.xml* ファイルのコメントに記載されています（ファイルのオンラインコピーについては、
`このリンク <https://github.com/ftctechnh/ftc_app/blob/master/TeamCode/src/main/res/xml/teamwebcamcalibrations.xml>`__
をご覧ください）。

**REV Robotics Expansion Hub** とスマートフォン
-----------------------------------------------

Android スマートフォンと **Expansion Hub** を使用しているチームは、ウェブカメラを使用するために USB Hub を追加する必要があります。

.. image:: images/uvcdiagram.png
   :alt: **REV Expansion Hub** が Android スマートフォンとウェブカメラに USB Hub 経由で接続されている図。

**USB Hub**
^^^^^^^^^^^

外部カメラを使用したいチームは、Android **Robot Controller** を外部カメラと **REV Robotics Expansion Hub** に接続するための USB ハブが必要です。適切に動作するために、USB ハブは以下の要件を満たす必要があります：

1. USB 2.0 との互換性があります。注：USB 3.0 ハブでも動作しますが、より高速な速度ではありません。
2. 480Mbps のデータ転送レートに対応しています。

Modern Robotics Core Power Distribution Module は、USB 接続ウェブカメラで動作するには十分な速度のデータ転送速度がないため、このタスクに使用することはできません。

また、競技マニュアルではこの接続にパワード USB ハブの使用を認めています。チームがパワード USB ハブを使用する場合、USB ハブを動作させるための電力は、次のいずれかのソースからのみ供給できます：

1. 競技マニュアルに準拠した、外部接続のオフザシェルフ（COTS）USB バッテリーパック。
2. **REV Robotics Expansion Hub** の 5V DC 補助電力ポート（この実装には高度なスキルが必要です）。

**FIRST** はいくつかの USB 2.0 パワード ハブをテストしており、Anker 製のハブを推奨しています。このドキュメント作成時点では、このハブは
`Anker.com <https://www.anker.com/products/a7516>`__ から入手できました。

.. image:: images/ankerhub.jpg
   :alt: チャージャーとケーブル付きのハブ。

Anker 4ポート パワード ハブは、ハブを 5V 電源に接続するために使用される Micro USB ポート（下図のオレンジ色の円で強調表示）があるため便利です。

.. image:: images/ankerpowerport.jpg
   :alt: Micro USB ポート付きの USB ハブ。

このポートにより、ユーザーは標準的な USB Type B Micro ケーブルをハブに接続してから、ケーブルの反対側（USB Type A コネクターが付いている）を外部 5V USB バッテリーパックの出力ポートに接続することができます。下の画像では、Anker 4 ポート ハブは標準的な Type A to Type B USB Micro ケーブルを使用して「limefuel」外部 5V バッテリーパックから電力を供給されています。バッテリーは下の図に黄色い枠で強調表示されています。

.. figure:: images/limefuel.png
   :alt: スマートフォンとウェブカメラを使用するための完全なセットアップ。
   
   USB ハブはバッテリーパックから電力を供給されています。

USB ハブは Type A コネクターとケーブルを介して OTG ケーブルに接続されており、このケーブルがスマートフォンに接続されています。
バッテリーパックは USB ハブの USB Type B Micro ポートに接続されています。
ウェブカメラは USB ハブの USB Type A ポートの 1 つに接続されています。
USB Type A to USB Mini B ケーブルが USB ハブを **REV Expansion Hub** に接続しています。

USB ハブは **REV Robotics Expansion Hub** の 5V 補助ポートからも電力を供給できます。この構成では、一方の端が 5V 補助ポートにプラグできる特殊なケーブルが必要であり、もう一方の端が USB ハブのパワーポートにプラグできる必要があります。

.. figure:: images/5vauxcable.png
   :alt: スマートフォンとウェブカメラを使用するための完全なセットアップ。
   
   USB ハブは 5V 補助ポートに接続されています。

チームは、サーボ延長ケーブルの一方の端（5V 補助ポートにプラグするため）と Micro USB ケーブルの一方の端（Anker ハブのパワーポートにプラグするため）を使用してこの特殊なケーブルを作成できることに注意してください。** このケーブルの作成は高度なタスクであり、電子機器と配線の専門知識を持つ成人メンターの指導を受けているチームのみが試みるべきです。このケーブルの極性が正しいことは非常に重要です。極性が逆転している場合、電子機器に損傷を与える可能性があります。**

サンプル **OpMode**
^^^^^^^^^^^^^^^^^^^

外部 UVC ウェブカメラを **VisionPortal** 操作で使用する方法を示すサンプル **Blocks** および Java **OpMode** があります。チームが外部 UVC カメラを使用する前に、外部カメラが USB 接続デバイスの 1 つとして定義された構成ファイルを構成する必要があります。

有効な構成ファイルが定義されてアクティブになると、プログラマーは内部 Android カメラの代わりに外部 UVC カメラを、ビジョン関連タスクに使用できます。

.. image:: images/blockswebcam.png
   :alt: サンプル **Blocks** コード

